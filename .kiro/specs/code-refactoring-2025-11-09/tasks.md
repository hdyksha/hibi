# リファクタリング実装タスク

## フェーズ1: サーバーサイドの基盤整備

- [ ] 1. バリデーションの統一
  - 共通のバリデーターユーティリティを作成し、`models/TodoItem.ts` のバリデーション関数を統合する
  - バリデーションロジックを簡素化し、重複を削除する
  - _要件: 1.1, 1.2, 2.1, 2.2, 7.1_

- [x] 1.1 共通バリデーターユーティリティの作成





  - `server/src/utils/validator.ts` を作成
  - `Validator` クラスと `ValidationRule` インターフェースを実装
  - 基本的なバリデーションルール（required、maxLength、minLength など）を実装
  - _要件: 1.1, 1.2, 7.1_

- [x] 1.2 TodoItem バリデーションの統合





  - `models/TodoItem.ts` の個別バリデーション関数を共通バリデーターを使用するように書き換え
  - `validateTitle`、`validatePriority`、`validateTags`、`validateMemo` を統合
  - 既存のバリデーションロジックを維持しながら、コードを簡素化
  - _要件: 1.1, 1.2, 2.1, 2.2_

- [x] 1.3 残りのバリデーション関数の統合





  - `validateCompleted`、`validateId`、`validateCreatedAt`、`validateUpdatedAt`、`validateCompletedAt` を共通バリデーターを使用するように書き換え
  - 日付バリデーションの重複コードを削除
  - 既存のバリデーションロジックを維持しながら、コードを簡素化
  - _要件: 1.1, 1.2, 2.1, 2.2_

- [x] 1.4 複合バリデーション関数の簡素化





  - `validator.ts` に `validateIfDefined` ヘルパー関数を追加
  - `validateCreateTodoItemInput`、`validateUpdateTodoItemInput`、`validateTodoItem` を `combineValidationResults` と `validateIfDefined` を使用して書き換え
  - 繰り返しのコードパターンを削除し、可読性を向上
  - 既存のバリデーションロジックを維持しながら、コード量を約60%削減
  - _要件: 1.1, 2.1, 2.2_

- [x] 1.5 バリデーションのテスト更新





  - 既存のバリデーションテストが引き続き合格することを確認
  - 必要に応じてテストを更新（シンプルなテストに留める）
  - _要件: 9.1, 9.2_

- [ ] 2. サービス層の整理
  - `TodoService` クラスを作成し、ビジネスロジックをルートハンドラーから移動する
  - フィルタリングロジックをサービス層に移動する
  - _要件: 1.1, 2.1, 2.2, 5.2_

- [x] 2.1 TodoService クラスの作成





  - `server/src/services/TodoService.ts` を作成
  - `getTodos`、`createTodo`、`updateTodo`、`deleteTodo` メソッドを実装
  - `FileStorageService` への依存を注入
  - _要件: 2.1, 2.2, 5.2_

- [x] 2.2 フィルタリングロジックの移動





  - `routes/todos.ts` のフィルタリングロジックを `TodoService` に移動
  - `applyFilter` メソッドを `TodoService` に実装
  - クエリパラメータのパース関数を抽出
  - _要件: 1.1, 2.1, 2.2_

- [x] 2.3 アーカイブロジックの移動





  - アーカイブ関連のロジックを `TodoService` に移動
  - `getArchive` メソッドを実装
  - _要件: 2.1, 2.2, 5.2_

- [x] 2.4 サービス層のテスト追加





  - `TodoService` の主要メソッドに対する基本的なテストを追加（シンプルなテストに留める）
  - フィルタリングロジックの基本的なテストを追加
  - _要件: 9.3_

- [ ] 3. ルートハンドラーの簡素化
  - `routes/todos.ts` を簡素化し、`TodoService` への委譲に専念させる
  - クエリパラメータのパース関数を抽出する
  - _要件: 2.1, 2.2, 4.1_

- [x] 3.1 ルートハンドラーのリファクタリング





  - `routes/todos.ts` の各ルートハンドラーを `TodoService` を使用するように書き換え
  - ビジネスロジックをサービス層に委譲
  - ルートハンドラーは薄く保つ
  - _要件: 2.1, 2.2, 4.1, 5.2_

- [x] 3.2 クエリパラメータパース関数の抽出




  - `buildFilterFromQuery` 関数を `utils` ディレクトリに移動
  - 再利用可能な形に整理
  - _要件: 1.1, 2.1, 4.1_

- [x] 3.3 ルートハンドラーのテスト更新





  - 既存のルートハンドラーテストが引き続き合格することを確認
  - 必要に応じてテストを更新（シンプルなテストに留める）
  - _要件: 9.1, 9.2_

## フェーズ2: クライアントサイドの基盤整備

- [ ] 4. API クライアントの分割
  - `apiClient.ts` を機能ごとに分割する
  - 共通のHTTPクライアントを抽出する
  - _要件: 1.1, 2.1, 2.2, 5.2_

- [x] 4.1 共通HTTPクライアントの作成





  - `client/src/services/http/HttpClient.ts` を作成
  - 共通のHTTPリクエスト処理を実装
  - エラーハンドリングを統一
  - _要件: 1.1, 6.1, 6.2, 6.3_

- [x] 4.2 TodoApi クラスの作成





  - `client/src/services/api/TodoApi.ts` を作成
  - Todo関連のAPI呼び出しを `TodoApi` クラスに移動
  - `HttpClient` を使用してリクエストを実行
  - _要件: 1.1, 2.1, 2.2, 5.2_

- [x] 4.3 FileApi クラスの作成





  - `client/src/services/api/FileApi.ts` を作成
  - File関連のAPI呼び出しを `FileApi` クラスに移動
  - `HttpClient` を使用してリクエストを実行
  - _要件: 1.1, 2.1, 2.2, 5.2_

- [x] 4.4 既存のapiClientの置き換え





  - `apiClient.ts` を削除または非推奨化
  - 新しい `TodoApi` と `FileApi` を使用するようにコードを更新
  - エクスポートを整理
  - _要件: 4.1, 4.2_

- [x] 4.5 API クライアントのテスト更新





  - 既存のAPI クライアントテストが引き続き合格することを確認
  - 新しい `TodoApi` と `FileApi` の基本的なテストを追加（シンプルなテストに留める）
  - _要件: 9.1, 9.2, 9.3_

- [ ] 5. 共通UIコンポーネントの作成
  - ボタン、入力フィールドなどの共通コンポーネントを作成する
  - スタイリングユーティリティを作成する
  - _要件: 1.1, 2.1, 5.1, 12.1_

- [x] 5.1 共通Buttonコンポーネントの作成





  - `client/src/components/common/Button.tsx` を作成
  - primary、secondary、danger などのバリアントを実装
  - サイズ、無効化状態などのプロップスを実装
  - _要件: 1.1, 5.1, 12.1_

- [x] 5.2 共通Inputコンポーネントの作成





  - `client/src/components/common/Input.tsx` を作成
  - エラー状態、無効化状態などのプロップスを実装
  - アクセシビリティを考慮
  - _要件: 1.1, 5.1, 12.1_

- [x] 5.3 スタイリングユーティリティの作成





  - `client/src/utils/styles.ts` を作成
  - 共通のスタイル定数を定義
  - スタイル結合ユーティリティ関数を実装
  - _要件: 1.1, 3.1, 12.1_

- [x] 5.4 共通コンポーネントのテスト追加





  - `Button` と `Input` コンポーネントの基本的なテストを追加（シンプルなテストに留める）
  - 基本的なレンダリングと動作のみをテスト
  - _要件: 9.3_

## フェーズ3: コンポーネントのリファクタリング

- [ ] 6. TodoItem コンポーネントの分割
  - `TodoItem.tsx` を小さなサブコンポーネントに分割する
  - プレゼンテーション層とロジック層を分離する
  - _要件: 2.1, 2.2, 5.1, 5.2_

- [x] 6.1 TodoItem サブコンポーネントの作成





  - `client/src/components/TodoItem/` ディレクトリを作成
  - `TodoItemHeader.tsx`、`TodoItemContent.tsx`、`TodoItemActions.tsx` を作成
  - 各サブコンポーネントに適切な責任を割り当て
  - _要件: 2.1, 2.2, 5.1_

- [x] 6.2 TodoItem メインコンポーネントのリファクタリング





  - `TodoItem.tsx` をサブコンポーネントを使用するように書き換え
  - ロジックをカスタムフックに抽出（必要に応じて）
  - 共通UIコンポーネント（Button など）を使用
  - _要件: 2.1, 2.2, 5.1, 5.2_

- [x] 6.3 スタイリングの改善





  - 長いTailwind CSSクラス名を共通のスタイリングユーティリティに置き換え
  - スタイルの一貫性を確保
  - _要件: 3.1, 12.1, 12.3_

- [x] 6.4 TodoItem コンポーネントのテスト更新





  - 既存のテストが引き続き合格することを確認
  - 必要に応じてテストを更新（シンプルなテストに留める）
  - _要件: 9.1, 9.2_

- [ ] 7. TodoForm コンポーネントの分割
  - `TodoForm.tsx` を小さなサブコンポーネントに分割する
  - フォーム管理ロジックをカスタムフックに抽出する
  - _要件: 2.1, 2.2, 5.1, 5.2_

- [x] 7.1 TodoForm サブコンポーネントの作成





  - `client/src/components/TodoForm/` ディレクトリを作成
  - `TodoFormBasic.tsx`、`TodoFormAdvanced.tsx` を作成
  - 各サブコンポーネントに適切な責任を割り当て
  - _要件: 2.1, 2.2, 5.1_

- [x] 7.2 フォーム管理カスタムフックの作成





  - `client/src/hooks/useTodoForm.ts` を作成
  - フォームの状態管理、バリデーション、送信処理を実装
  - _要件: 2.2, 5.2_

- [x] 7.3 TodoForm メインコンポーネントのリファクタリング





  - `TodoForm.tsx` をサブコンポーネントとカスタムフックを使用するように書き換え
  - 共通UIコンポーネント（Button、Input など）を使用
  - _要件: 2.1, 2.2, 5.1, 5.2_

- [x] 7.4 TodoForm コンポーネントのテスト更新





  - 既存のテストが引き続き合格することを確認
  - 必要に応じてテストを更新（シンプルなテストに留める）
  - _要件: 9.1, 9.2, 9.3_

- [ ] 8. Filter コンポーネントの分割
  - `Filter.tsx` を小さなサブコンポーネントに分割する
  - フィルター管理ロジックを整理する
  - _要件: 2.1, 2.2, 5.1_

- [x] 8.1 Filter サブコンポーネントの作成





  - `client/src/components/Filter/` ディレクトリを作成
  - `FilterSearch.tsx`、`FilterStatus.tsx`、`FilterPriority.tsx`、`FilterTags.tsx` を作成
  - 各サブコンポーネントに適切な責任を割り当て
  - _要件: 2.1, 2.2, 5.1_

- [x] 8.2 Filter メインコンポーネントのリファクタリング





  - `Filter.tsx` をサブコンポーネントを使用するように書き換え
  - 共通UIコンポーネント（Button、Input など）を使用
  - _要件: 2.1, 2.2, 5.1_

- [x] 8.3 Filter コンポーネントのテスト更新





  - 既存のテストが引き続き合格することを確認
  - 必要に応じてテストを更新（シンプルなテストに留める）
  - _要件: 9.1, 9.2_

- [ ] 9. Archive コンポーネントのリファクタリング
  - `Archive.tsx` を小さなサブコンポーネントに分割する
  - 共通UIコンポーネントを使用する
  - _要件: 2.1, 2.2, 5.1_

- [x] 9.1 Archive サブコンポーネントの作成





  - `client/src/components/Archive/` ディレクトリを作成
  - `ArchiveGroup.tsx`、`ArchiveTask.tsx` を作成
  - 各サブコンポーネントに適切な責任を割り当て
  - _要件: 2.1, 2.2, 5.1_

- [x] 9.2 Archive メインコンポーネントのリファクタリング





  - `Archive.tsx` をサブコンポーネントを使用するように書き換え
  - 共通UIコンポーネント（Button など）を使用
  - _要件: 2.1, 2.2, 5.1_

- [x] 9.3 Archive コンポーネントのテスト更新





  - 既存のテストが引き続き合格することを確認
  - 必要に応じてテストを更新（シンプルなテストに留める）
  - _要件: 9.1, 9.2_

## フェーズ4: コードの品質向上

- [ ] 10. テストコードの改善
  - MockProvidersを活用してテストコードを簡潔にする
  - vi.mockの使用を最小限に抑える
  - _要件: 9.1, 9.2, 12.1_

- [x] 10.1 Archive.test.tsx のリファクタリング





  - `TestProviders` を使用して NetworkProvider と TodoProvider を置き換え
  - `vi.mock('../../hooks/useNetworkStatus')` を削除
  - renderArchive ヘルパー関数を簡素化
  - 既存のテストが引き続き合格することを確認
  - _要件: 1.1, 9.1, 9.2, 12.1_

- [x] 10.2 TodoForm.test.tsx のリファクタリング





  - `TestProviders` を使用してプロバイダーを提供
  - `useTodoContext` のモックは継続（テストの柔軟性のため）
  - コードの一貫性を向上
  - 既存のテストが引き続き合格することを確認
  - _要件: 1.1, 9.1, 9.2, 12.1_

- [x] 10.3 TodoList.test.tsx のリファクタリング





  - `TestProviders` を使用してプロバイダーを提供
  - `useTodoContext` のモックは継続（テストの柔軟性のため）
  - コードの一貫性を向上
  - 既存のテストが引き続き合格することを確認
  - _要件: 1.1, 9.1, 9.2, 12.1_

- [ ] 11. カスタムフックの整理
  - `useTodos.ts` の責任を明確化する
  - 必要に応じてフックを分割する
  - _要件: 2.1, 2.2, 5.2_

- [x] 11.1 useTodos フックのリファクタリング





  - `useTodos.ts` を確認し、責任を明確化
  - 必要に応じて小さなフックに分割
  - エラーハンドリングロジックを統一
  - _要件: 2.1, 2.2, 5.2, 6.1_

- [x] 11.2 カスタムフックのテスト更新









  - 既存のテストが引き続き合格することを確認
  - 必要に応じてテストを更新（シンプルなテストに留める）
  - _要件: 9.1, 9.2, 9.3_

- [ ] 12. 命名の改善
  - 不明確な変数名や関数名を改善する
  - 一般的でない略語を完全な単語に展開する
  - _要件: 3.1, 3.2, 3.3_

- [x] 12.1 サーバーサイドの命名改善





  - `server/src` 配下のファイルを確認
  - 不明確な変数名や関数名を改善
  - 一貫した命名規則を適用
  - _要件: 3.1, 3.2, 3.3, 12.1_

- [x] 12.2 クライアントサイドの命名改善





  - `client/src` 配下のファイルを確認
  - 不明確な変数名や関数名を改善
  - 一貫した命名規則を適用
  - _要件: 3.1, 3.2, 3.3, 12.1_

- [ ] 13. 型安全性の向上
  - `any` 型の使用を削減する
  - 型アサーションを型ガードに置き換える
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 13.1 サーバーサイドの型安全性向上





  - `server/src` 配下のファイルを確認
  - `any` 型を具体的な型に置き換え
  - 型アサーションを型ガードに置き換え
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 13.2 クライアントサイドの型安全性向上





  - `client/src` 配下のファイルを確認
  - `any` 型を具体的な型に置き換え
  - 型アサーションを型ガードに置き換え
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 13.3 環境変数チェックのモダン化





  - `useNetworkStatus.ts` の環境変数チェックを Vite 標準の方法に変更
  - `process.env.NODE_ENV` を `import.meta.env.MODE` に置き換え
  - `typeof process !== 'undefined'` チェックを削除してコードを簡素化
  - _要件: 10.1, 10.2, 10.3_

- [ ] 14. 不要なコードの削除
  - 使用されていない関数やコンポーネントを削除する
  - 使用されていないインポートを削除する
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [x] 14.1 サーバーサイドの不要なコード削除





  - `server/src` 配下のファイルを確認
  - 使用されていない関数、変数、インポートを削除
  - コメントアウトされたコードを削除
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 14.2 クライアントサイドの不要なコード削除
  - `client/src` 配下のファイルを確認
  - 使用されていない関数、変数、インポートを削除
  - コメントアウトされたコードを削除
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 15. コメントとドキュメントの追加
  - 複雑なロジックにコメントを追加する
  - JSDocコメントを更新する
  - _要件: 13.1, 13.2, 13.3_

- [ ] 15.1 サーバーサイドのドキュメント追加
  - 複雑なロジックにコメントを追加
  - 公開APIにJSDocコメントを追加
  - 新しいユーティリティ関数に使用例を追加
  - _要件: 13.1, 13.2, 13.3_

- [ ] 15.2 クライアントサイドのドキュメント追加
  - 複雑なロジックにコメントを追加
  - 公開APIにJSDocコメントを追加
  - 新しいコンポーネントにプロップスの説明を追加
  - _要件: 13.1, 13.2, 13.3_

- [ ] 15.3 READMEの更新
  - アーキテクチャの変更を反映
  - 新しいディレクトリ構造を文書化
  - _要件: 13.4_

- [ ] 16. パフォーマンスの最適化
  - 不要な再レンダリングを削減する
  - コールバック関数を最適化する
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [ ] 16.1 React.memo の適用
  - 不要に再レンダリングされるコンポーネントを特定
  - `React.memo` を適用して最適化
  - _要件: 8.1_

- [ ] 16.2 useCallback の適用
  - 毎回再作成されるコールバック関数を特定
  - `useCallback` を適用して最適化
  - _要件: 8.2_

- [ ] 16.3 useMemo の適用
  - 重い計算が毎回実行される箇所を特定
  - `useMemo` を適用して結果をキャッシュ
  - _要件: 8.3_

- [ ] 17. 最終確認とテスト
  - すべてのテストが合格することを確認する
  - 機能が正常に動作することを確認する
  - _要件: 9.1, 9.2, 9.4_

- [ ] 17.1 サーバーサイドのテスト実行
  - `npm run test:server` を実行
  - すべてのテストが合格することを確認
  - 失敗したテストがあれば修正
  - _要件: 9.1, 9.2, 9.4_

- [ ] 17.2 クライアントサイドのテスト実行
  - `npm run test:client` を実行
  - すべてのテストが合格することを確認
  - 失敗したテストがあれば修正
  - _要件: 9.1, 9.2, 9.4_

- [ ] 17.3 統合テストの実行
  - アプリケーション全体が正常に動作することを確認
  - 主要な機能をマニュアルでテスト
  - _要件: 9.4_

- [ ] 17.4 コードレビューとクリーンアップ
  - コード全体を確認し、一貫性を確保
  - 最終的なクリーンアップを実施
  - _要件: 12.1, 12.2, 12.3, 12.4_
